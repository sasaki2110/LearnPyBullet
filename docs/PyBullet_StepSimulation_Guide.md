# PyBullet stepSimulation() のステップ数の決め方

このドキュメントでは、`stepSimulation()`を呼び出す際のステップ数（`range()`の値）をどう決めるかを説明します。

---

## 基本的な考え方

### 1. PyBulletのタイムステップ

PyBulletのデフォルトタイムステップは **1/240秒**（約0.00417秒）です。

```python
# デフォルトのタイムステップ
time_step = 1.0 / 240.0  # 約0.00417秒
```

つまり、`stepSimulation()`を1回呼ぶと、シミュレーション時間が約0.00417秒進みます。

### 2. ステップ数と実時間の関係

```python
# ステップ数から実時間を計算
実時間（秒） = ステップ数 × (1/240)
```

**例：**
- `range(50)`: 50ステップ = 50/240秒 ≈ **0.21秒**
- `range(100)`: 100ステップ = 100/240秒 ≈ **0.42秒**
- `range(1000)`: 1000ステップ = 1000/240秒 ≈ **4.17秒**

---

## 用途別のステップ数の目安

### 1. 初期化・安定化（range(10) 〜 range(50)）

**目的**: ロボットやオブジェクトをロードした直後、物理演算を少し進めて安定させる

```python
# ロボットをロード
robot_id = p.loadURDF("r2d2.urdf", basePosition=[0, 0, 1.0])

# 初期状態を安定させるために少しシミュレーションを進める
for _ in range(50):
    p.stepSimulation()
```

**なぜ50ステップ？**
- ロボットが落下し始めて、物理演算が安定するまでの時間
- 約0.2秒で、多くの場合十分な安定化時間
- 実際のコード例：
  - `p01_check_connection.py`: `range(50)` - テスト目的
  - `p05_r2d2_walk.py`: `range(50)` - 初期安定化
  - `agents/p02_ex_arm2`: `range(10)` - 環境初期化（固定ベースなので短くてOK）

**推奨値：**
- 固定ベースのロボット: `range(10)` 〜 `range(20)`
- 自由落下するオブジェクト: `range(50)` 〜 `range(100)`

---

### 2. 動作確認・テスト（range(50) 〜 range(200)）

**目的**: ロボットの動作を確認する短いテスト

```python
# 物理シミュレーションの進展テスト
for i in range(50):
    p.stepSimulation()
    if i % 10 == 0:
        pos, _ = p.getBasePositionAndOrientation(robot_id)
        print(f"ステップ {i}: ロボットの現在の高さ = {pos[2]:.4f}m")
```

**なぜ50ステップ？**
- 高さ1mから落下するロボットの場合：
  - 自由落下の計算: `t = sqrt(2h/g) = sqrt(2×1/9.81) ≈ 0.45秒`
  - 50ステップ ≈ 0.21秒なので、落下の途中まで観察できる
  - 動作確認には十分な時間

**推奨値：**
- 落下テスト: `range(50)` 〜 `range(100)`
- 簡単な動作確認: `range(100)` 〜 `range(200)`

---

### 3. 本番シミュレーション（range(1000) 〜 range(10000)）

**目的**: 実際のタスクを実行する長時間のシミュレーション

```python
# シミュレーションループ
max_steps = 5000  # 約20秒（240Hzで）
for i in range(max_steps):
    # ロボットの制御
    # ...
    p.stepSimulation()
    time.sleep(1./240.)  # リアルタイム表示用
```

**なぜ1000ステップ以上？**
- ロボットの制御タスクには時間がかかる
- 例：アームを動かして物体を把持する → 数秒〜数十秒必要
- `range(1000)` ≈ 4.17秒、`range(5000)` ≈ 20.8秒

**実際のコード例：**
- `p03_spawn_objects.py`: `range(1000)` - 約4秒のシミュレーション
- `p04_move_to_tray.py`: `range(1000)` - アーム制御タスク
- `p05_r2d2_walk.py`: `range(5000)` - 約20秒の歩行シミュレーション

**推奨値：**
- 短いタスク: `range(1000)` 〜 `range(2000)` （約4〜8秒）
- 中程度のタスク: `range(5000)` 〜 `range(10000)` （約20〜40秒）
- 長時間タスク: `range(10000)` 以上

---

## ステップ数の計算方法

### 方法1: 実時間から計算

```python
# 実時間（秒）からステップ数を計算
desired_time_seconds = 5.0  # 5秒間シミュレーションしたい
time_step = 1.0 / 240.0  # デフォルトタイムステップ
steps = int(desired_time_seconds / time_step)
# steps = 1200

for i in range(steps):
    p.stepSimulation()
```

### 方法2: 物理現象から計算

**例：高さhから落下する物体が地面に到達するまでのステップ数**

```python
import math

h = 1.0  # 高さ1m
g = 9.81  # 重力加速度
time_step = 1.0 / 240.0

# 自由落下の時間を計算
fall_time = math.sqrt(2 * h / g)  # ≈ 0.45秒

# ステップ数に変換
steps = int(fall_time / time_step)  # ≈ 108ステップ

# 少し余裕を持たせる
steps = int(steps * 1.2)  # ≈ 130ステップ

for i in range(steps):
    p.stepSimulation()
```

---

## よくある質問

### Q1: なぜ50ステップなのか？もっと多くした方がいいのでは？

**A:** 用途によります。

- **初期化・安定化**: 50ステップ（約0.2秒）で十分なことが多い
- **動作確認**: 50ステップでも確認できるが、100ステップの方が確実
- **本番タスク**: タスクの長さに応じて1000ステップ以上

**判断基準：**
- ロボットが安定した状態になったか？
- 目的の動作が完了したか？
- それらが確認できれば、そのステップ数でOK

---

### Q2: ステップ数を増やすと何が変わる？

**A:** 
- ✅ **良い点**: より長い時間のシミュレーションが可能、より安定した結果
- ❌ **悪い点**: 計算時間が増える、メモリ使用量が増える可能性

**バランスが重要：**
- 必要最小限のステップ数を使う
- 目的に応じて適切な値を選択

---

### Q3: タイムステップを変更した場合は？

**A:** タイムステップを変更した場合、ステップ数も調整が必要です。

```python
# タイムステップを変更（例：120Hzに変更）
p.setTimeStep(1.0 / 120.0)  # 0.0083秒/ステップ

# 同じ実時間（5秒）をシミュレーションする場合
desired_time = 5.0
time_step = 1.0 / 120.0
steps = int(desired_time / time_step)  # 600ステップ（240Hzの場合は1200ステップ）

for i in range(steps):
    p.stepSimulation()
```

---

## まとめ

| 用途 | 推奨ステップ数 | 実時間（240Hz） | 使用例 |
|------|--------------|----------------|--------|
| 初期化・安定化 | 10〜50 | 0.04〜0.21秒 | ロボットロード後 |
| 動作確認・テスト | 50〜200 | 0.21〜0.83秒 | 落下テスト |
| 短いタスク | 1000〜2000 | 4.17〜8.33秒 | 簡単な制御 |
| 中程度のタスク | 5000〜10000 | 20.8〜41.7秒 | 歩行、把持 |
| 長時間タスク | 10000以上 | 41.7秒以上 | 複雑なタスク |

**重要なポイント：**
1. **デフォルトタイムステップ**: 1/240秒（約0.00417秒）
2. **実時間 = ステップ数 × (1/240)**
3. **用途に応じて適切な値を選択**
4. **必要最小限のステップ数を使う**

`p01_check_connection.py`の`range(50)`は、**動作確認テスト**として、ロボットが落下する様子を観察するのに十分な時間（約0.2秒）を確保するための値です。
