# Vision60（四足ロボット）実装進捗ドキュメント

## 最終更新日
2026年1月15日（最新：足踏み動作の修正完了、速度調整、色変更タイミング同期、ログ分析による動作確認）

## 概要
Vision60（逆関節四足ロボット）のPyBulletシミュレーション実装の進捗状況を記録します。

## 現在の実装状況

### ファイル
- `/root/LearnPyBullet/srcs/p08_vision60.py` - メイン実装ファイル（約1280行、逆運動学コード含む）

### 実装済み機能
1. ✅ ロボットの登場（URDFロード）
2. ✅ 基本的な姿勢制御（立つ姿勢の設定）
3. ✅ ジョイント情報の取得と表示
4. ✅ リンク情報の取得と表示
5. ✅ **膝上・膝下の角度測定とロギング機能**
6. ✅ **リンク名から正しいリンクインデックスを取得する機能**
7. ✅ **PD制御パラメータ（positionGain, velocityGain）の実装**
8. ✅ **姿勢フィードバック制御（roll/pitchに基づく動的調整）**
9. ✅ **リセット統計の記録と表示**
10. ✅ **脚を閉じた状態で登場させる方法（安定化に成功）**
11. ✅ **段階的な立ち上がり動作の実装（線形補間による角度変更）**
12. ✅ **立ち上がり時の力とゲインの動的調整（安定性優先の弱い力モード）**
13. ✅ **初期角度の固定化（initial_standing_angles）**
14. ✅ **右前への傾き修正制御（knee角度を直接調整して傾きを修正）**
15. ✅ **接地状態に基づく修正制御（浮上している脚を下げる）**
16. ✅ **物理パラメータの調整（質量増加、減衰追加、反発係数低減）**
17. ✅ **立ち上がり完了後の安定化検知機能（「もじもじ期」から「安定期」への移行を検知）**
18. ✅ **安定化時の各脚の詳細状態ログ出力（膝角度、逆関節形状の判定）**
19. ✅ **左右対称制御の改善（左右が同時に目標に到達するようにする）**
20. ✅ **足踏み動作の実装（対角線の脚を交互に上げ下げ）**
21. ✅ **リセット処理の改善（位置を初期位置に戻す、速度をリセット）**
22. ✅ **物理パラメータの最適化（ジョイント制御の力を現実的な値に制限）**
23. ✅ **ログ表示の改善（各モジュール名が正しく表示されるように修正）**
24. ✅ **色変更機能の追加（状態に応じてロボットの色を変更）**

## ✅ 解決した問題

### 1. 姿勢の安定化（2026年1月13日解決）
- **解決方法**: 脚を閉じた状態（knee=0.5ラジアン、約28.6度）で登場させ、そのまま放置
- **結果**: 500ステップ中リセット0回、姿勢roll=-0.0°, pitch=0.0°, yaw=0.0°（完璧に水平）
- **位置**: (-0.013, 0.000, 0.202) - ほぼ原点で安定
- **重要な発見**: 初期姿勢の設定方法が安定性に大きく影響する

### 2. 逆関節の形状実現（2026年1月13日解決）
- **解決方法**: 脚を閉じた状態で登場させることで、GUIで確認したところ理想的な逆くの字の形状を実現
- **結果**: 膝上は水平に近く、関節が深く曲がり、安定して立っている
- **注意**: ログの判定ロジック（膝下のpitch判定）が正しく動作していない可能性あり（実際には逆関節になっているのに警告が出る）

### 3. 安定化の理由の解明（2026年1月13日解決）
- **発見**: 立ち上がり完了後、「もじもじ期」から「安定期」への移行タイミングを検知できるようになった
- **安定化検知機能**: 
  - 立ち上がり完了後（progress >= 1.0）から10ステップごとに安定性をチェック
  - 姿勢の変化率（roll/pitch）、位置の変化率（Z方向）、膝角度の変化率を監視
  - 急に安定した瞬間（変化率が急に小さくなる）を検知
- **安定化のタイミング**: ステップ2190（立ち上がり完了から170ステップ後）
- **安定化の兆候**: Z位置の変化率が急に小さくなった（0.0221m → 0.0083m/10step）
- **安定化時の状態**:
  - 前脚（FL）と後脚（BL）が先に「逆関節（くの字）」形状になる（膝角度90度以上）
  - 4本すべてが接地し、支持基底が確保される
  - これにより「もじもじ期」から「安定期」へ移行
- **座標系の問題の解決**: 
  - 膝下リンクのpitch判定が座標系の向きにより誤判定される問題を発見
  - 膝角度（90度以上）を基準に判定することで、GUIで確認した「くの字」形状を正しく判定

## ✅ 最新の改善（2026年1月15日）

### 1. リセット処理の改善（2026年1月15日）
- **問題**: リセット時に位置を修正した際、物理エンジンで急激な上昇が発生していた
- **解決方法**:
  - X, Y座標を初期位置に戻し、Z座標（高さ）は現在の高さを維持
  - ベースの速度と角速度をゼロにリセット
  - すべてのジョイントの速度をゼロにリセット（角度は維持）
- **結果**: リセットがスムーズになり、跳ね上がりが解消

### 2. 物理パラメータの最適化（2026年1月15日）
- **問題**: ジョイント制御の力が200Nと大きすぎて、物理法則を無視した動き（1本足や2本足だけで立つ）が発生
- **解決方法**:
  - ジョイント制御の力を200N → 30Nに削減（15kgのロボットに対して現実的な値）
  - タイムステップを1/240秒 → 1/480秒に細かく設定（物理シミュレーションの精度向上）
  - PyBulletのタイムステップを明示的に設定
- **結果**: 物理シミュレーターとして信頼性の高い動作になり、不自然な動きが解消

### 3. 足踏み動作の改善（2026年1月15日）
- **問題**: 足踏み中に姿勢が大きく傾き、1本足や2本足だけで立つ不自然な動きが発生
- **解決方法**:
  - 足踏み動作の角度調整量を小さく（hip: 0.4→0.15、knee: 0.3→0.1）
  - 足踏み中は姿勢フィードバック制御を無効化（足踏み動作と競合しないように）
  - 足踏み中の接地状態をログに追加
- **結果**: 足踏み動作がより安定したが、時間が短すぎる課題が残る

### 4. ログ表示の改善（2026年1月15日）
- **問題**: すべてのログが`p08_vision60.logger`として表示されていた
- **解決方法**: `Logger`クラスの各メソッドに`logger`パラメータを追加し、呼び出し元から適切なロガーを渡すように変更
- **結果**: 各モジュール名（`standing_control`, `stepping_control`, `main`など）が正しく表示されるように

### 5. 色変更機能の追加（2026年1月15日）
- **実装内容**:
  - 状態に応じてロボットの色を変更する機能を追加
  - 通常時: 青系、立ち上がり中: オレンジ系、足踏み中: 緑系、終了待機中: 紫系
  - オリジナルの色（半透明）を保存し、足踏み1サイクル完了時に戻す機能
- **目的**: 足踏み中と終了待機中を視覚的に判別できるように

### 6. 足踏み動作の修正と最適化（2026年1月15日 - 最新）
- **問題1**: 股関節の回転方向が実機と異なる
  - BR（右後ろ足）とBL（左後ろ足）のhip回転方向が間違っていた（`-=` → `+=`に修正）
- **解決方法1**:
  - フェーズ0（FL+BRを上げる）: BRのhip回転方向を修正（`-=` → `+=`）
  - フェーズ2（FR+BLを上げる）: BLのhip回転方向を修正（`-=` → `+=`）
  - 実機の動作に合わせて、両脚とも股関節を後ろ側に回すように変更
- **問題2**: 角度調整量が適切でない（水平移動が大きい、垂直上昇が小さい）
- **解決方法2**:
  - 股関節の角度: `0.4` → `0.3`ラジアン（約17度、水平移動を抑制）
  - 膝の角度: `0.3` → `0.5`ラジアン（約29度、垂直上昇を増やす）
- **問題3**: 足踏み速度が遅すぎる
- **解決方法3**:
  - `STEPPING_PHASE_DURATION`: 2400ステップ（5秒/フェーズ）→ 240ステップ（0.5秒/フェーズ）
  - 1サイクル（4フェーズ）: 20秒 → 2秒
  - 「タッタッタッタッ」というリズムで動作
- **問題4**: 色変更のタイミングが足踏みのタイミングと同期していない
- **解決方法4**:
  - 各フェーズの開始時に色を変更するように修正
  - フェーズ0, 2（足を上げる）: 緑色
  - フェーズ1, 3（足を戻す）: オリジナルの色（グレー）
- **結果**: 
  - ✅ 対角線の脚が適切に浮上・接地している
  - ✅ 足先が垂直方向に上がっている（平均足先高さ: 0.031-0.041m）
  - ✅ 姿勢が安定している（roll=-0.2°, pitch=-0.3°～-1.6°）
  - ✅ フェーズ遷移が正しく動作している
  - ✅ 色変更がタイミングと同期している
  - ✅ ログ分析により、動作が正常であることを確認

## 現在の問題点

### 1. 足踏み動作が実機と異なる（2026年1月15日 - ✅ 解決済み）

**問題の概要：**
シミュレーションの足踏み動作が実機の動作と大きく異なっている。特に、股関節の回転方向と膝の曲げ方が実機と一致していない。

**具体的な問題：**

**フェーズ0（FL+BRを上げる）：**
- **実機の動作：**
  - FL（左前）：股関節を後ろ側に回す（逆時計回り）、膝を閉じる → 足先が垂直に上がる
  - BR（右後）：股関節を後ろ側に回す（時計回り）、膝を閉じる → 足先が垂直に上がる
  
- **現在のシミュレーション（修正前）：**
  - FL：股関節を後ろ向きに回す（`hip += 0.4`）→ **足先が前方向に移動**（ログ: X=0.276→0.506）
  - BR：股関節を前向きに回す（`hip -= 0.4`）→ **足先が後ろ方向に移動**（ログ: X=-0.303→-0.398）
  - 膝は閉じているが、足先の水平方向の移動が実機と逆

**フェーズ2（FR+BLを上げる）：**
- **実機の動作：**
  - FR（右前）：股関節を後ろ側に回す（時計回り）、膝を閉じる
  - BL（左後）：股関節を後ろ側に回す（逆時計回り）、膝を閉じる
  
- **現在のシミュレーション（修正前）：**
  - FR：股関節を後ろ向きに回す（`hip += 0.4`）→ 足先が後ろ方向に移動
  - BL：股関節を前向きに回す（`hip -= 0.4`）→ 足先が前方向に移動

**実施した修正（2026年1月15日）：**
1. ✅ **股関節の回転方向の修正**:
   - フェーズ0：BRのhip回転方向を修正（`-=` → `+=`）
   - フェーズ2：BLのhip回転方向を修正（`-=` → `+=`）
   - 実機の動作に合わせて、両脚とも股関節を後ろ側に回すように変更

2. ✅ **角度調整量の最適化**:
   - 股関節の角度: `0.4` → `0.3`ラジアン（約17度、水平移動を抑制）
   - 膝の角度: `0.3` → `0.5`ラジアン（約29度、垂直上昇を増やす）

**ログから確認できる挙動（修正前）：**
- フェーズ0（ステップ2300-3400付近）:
  - FLの足先位置X: 0.276 → 0.283 → 0.296 → 0.312 → 0.320 → 0.342 → ... → 0.409（前方向に移動）
  - BRの足先位置X: -0.289 → -0.263 → -0.244 → -0.224 → -0.206 → -0.188 → -0.171（後ろ方向に移動）
  - BRの足先位置Z（高さ）: 0.027 → 0.033 → 0.038 → 0.045 → 0.052（約2.5cm上昇、動きが小さい）

**修正方針：**
1. **股関節の回転方向の修正** - ✅ 完了
   - 実機の動作に合わせて、両脚とも股関節を後ろ側に回す
   - 座標系の確認が必要（左右・前後で正負の意味が異なる可能性）

2. **膝の曲げ方の確認** - ✅ 完了
   - 膝の角度を増やして、足先をより垂直に上げる（0.3 → 0.5ラジアンに変更済み）

3. **足先位置の目標** - ✅ 完了
   - 実機では「足先が垂直に上がる」ことが重要
   - 水平方向（X方向）の移動を最小化し、垂直方向（Z方向）に上げる
   - ログ分析により、動作が改善されていることを確認

4. **足替え時間の調整** - ✅ 完了
   - 2400ステップ（5秒/フェーズ）→ 240ステップ（0.5秒/フェーズ）に短縮
   - 1サイクル（4フェーズ）: 20秒 → 2秒
   - 「タッタッタッタッ」というリズムで動作

**動作確認結果（2026年1月15日）：**
- ✅ 対角線の脚が適切に浮上・接地している
- ✅ 足先が垂直方向に上がっている（平均足先高さ: 0.031-0.041m）
- ✅ 姿勢が安定している（roll=-0.2°, pitch=-0.3°～-1.6°）
- ✅ フェーズ遷移が正しく動作している
- ✅ 色変更がタイミングと同期している

**関連ファイル：**
- `/root/LearnPyBullet/agents/p08_vision60/my_agent/utils/stepping_control.py` - 足踏み制御（修正対象）
- `/root/LearnPyBullet/agents/p08_vision60/my_agent/utils/robot_model.py` - ロボットモデル（座標系確認）
- `/root/LearnPyBullet/agents/p08_vision60/my_agent/utils/config.py` - 設定（フェーズ継続時間など）
- `/root/LearnPyBullet/agents/p08_vision60/p08_vision60.log` - ログファイル（挙動確認）

### 2. 足踏み時間の調整（2026年1月15日 - ✅ 解決済み）
- **問題**: 足踏み動作の時間が長すぎて、動作が遅く見える
- **解決方法**: 
  - `STEPPING_PHASE_DURATION`: 2400ステップ（5秒/フェーズ）→ 240ステップ（0.5秒/フェーズ）
  - 1サイクル（4フェーズ）: 20秒 → 2秒
  - 「タッタッタッタッ」というリズムで動作
- **結果**: 
  - ✅ 足踏み動作が適切な速度で実行されている
  - ✅ ログ分析により、動作が正常であることを確認
  - ✅ 色変更がタイミングと同期している

### 2. 立ち上がり動作の改善（2026年1月13日 - 大幅に改善、継続改善中）
- **改善状況（最新）**: 
  - ✅ **リセット回数が大幅に減少**: 29回 → 1回（3000ステップ中）
  - ✅ **後脚（BL, BR）が目標角度に到達**: BL=97.4°, BR=97.4°（目標達成！）
  - ✅ **姿勢の安定性が向上**: roll=0.8°（ほぼ水平）
  - ⚠️ **前脚（FL, FR）がまだ目標に到達していない**: FL=43.3°, FR=21.2°（目標97.4°に対して大幅な誤差）
  - ⚠️ **接地状態が不安定**: FR, BL, BRが浮上、FLが弱い接地（1点, 10.0N）
- **実施した修正（2026年1月13日 - 第1弾）**:
  1. ✅ **力を増加**: `current_force`を10.0から20.0に増加（通常の10%）
  2. ✅ **ゲインを増加**: `position_gain * 0.1`→`0.2`、`velocity_gain * 0.1`→`0.2`に増加
  3. ✅ **リセット閾値を緩和**: 立ち上がり中は姿勢傾きの閾値を15度→25度に緩和
  4. ✅ **進行度ログ出力**: 立ち上がり中の進行度と現在のknee角度を100ステップごとにログ出力
- **新たな問題（2026年1月13日 - 第2弾修正中）**:
  - 立ち上がり中に前のめりになって、ぴくぴくしだす
  - 立ち上がり後（ステップ2050以降）にリセットが頻発（位置移動、姿勢傾き）
- **実施した修正（2026年1月13日 - 第2弾）**:
  1. ✅ **後傾姿勢で立ち上がる**: 前脚のhipを0.3→0.5に増加（後ろ向きに）、後脚のhipを0.4→-0.2に変更（前向きに）
  2. ✅ **立ち上がり中の姿勢フィードバック強化**: pitchフィードバックゲインを立ち上がり中は2倍に増加
- **新たな問題（2026年1月13日 - 第3弾修正中）**:
  - 立ち上がるときに、左足を上げようとしている
  - 少しずつ、右前へ傾いている（X方向に右へ移動、pitchが前のめり）
- **実施した修正（2026年1月13日 - 第3弾）**:
  1. ✅ **立ち上がり中のrollフィードバック強化**: rollフィードバックゲインを立ち上がり中は2倍に増加（左右バランス強化）
  2. ✅ **位置フィードバック追加**: X方向の移動を抑制する位置フィードバックを追加（右前への傾きを防ぐ）
- **逆運動学の試行と失敗（2026年1月13日）**:
  - **試行内容**: 逆運動学（IK）を使用して、4つの足先を同時に下げることで反作用でロボットを持ち上げる方式を実装
  - **実装内容**:
    - `p.calculateInverseKinematics()`を使用して各脚のエンドエフェクタ（足先）位置からジョイント角度を計算
    - 初期足先位置からZ方向に5cm下げた位置を目標として設定
    - 線形補間で目標位置に近づける
  - **結果**: 完全に失敗（リセットが頻発、姿勢が大きく崩れる）
  - **失敗の原因（推測）**:
    - Vision60のURDFモデルが`calculateInverseKinematics()`に適していない可能性
    - 各脚を独立に計算するため、全体のバランスが崩れやすい
    - ジョイントの制約や可動範囲が適切に反映されていない
  - **対応**: 逆運動学を無効化（`use_ik_for_standing_up = False`）し、従来の角度指定方式に戻す
- **現在の状態（最新 - 2026年1月13日）**: 
  - 物理パラメータ調整により、安定性が大幅に改善
  - 後脚（BL, BR）は目標角度（97.4°）に到達
  - 前脚（FL, FR）はまだ目標に到達していない（FL=43.3°, FR=21.2°）
  - リセット回数が1回に減少（大幅改善）
- **次のステップ**: 
  - 前脚（FL, FR）の膝角度を目標に到達させる
  - 4本すべての脚が安定して接地するようにする

### 2. 判定ロジックの改善（2026年1月13日 - 改善済み）
- **問題**: 膝下リンクのpitch判定が座標系の向きにより誤判定される
- **原因**: `getLinkState`で取得した姿勢はワールド座標系での姿勢であり、膝下リンクのローカル座標系が膝上リンクとは異なる向きに定義されている可能性
- **解決方法**: 膝角度（90度以上）を基準に判定することで、GUIで確認した「くの字」形状を正しく判定
- **結果**: 安定化検知時に、各脚の状態を正しく判定できるようになった

### 4. 左右対称制御の改善（2026年1月13日解決）
- **問題**: 左側（FL, BL）が先に逆関節になるのに対して、右側（FR, BR）が後から追いつく
- **原因**: 右脚が左脚に依存する制御（右脚の角度を左脚の逆にする処理）により、左右が同時に目標に到達できない
- **解決方法**:
  - 右脚を左脚に依存させるのではなく、左右対称に制御
  - 左右のバランスを取る制御を追加（左右差が大きい場合、バランスを取る）
  - 膝角度の左右差を監視して、左右が同時に目標に到達するようにする
- **実装内容**:
  - 左右のabduction角度のバランス調整
  - 左右のhip角度のバランス調整
  - 左右の膝角度のバランス調整（左右差が0.2ラジアン以上の場合、バランスを取る）
- **結果**: 左右が同時に目標に到達するようになり、安定性が向上

### 5. 足踏み動作の実装（2026年1月13日解決）
- **目的**: 位置が動かないように、対角線の脚を交互に上げ下げする動作
- **実装内容**:
  - 安定化検知後に自動開始
  - 4つのフェーズを繰り返す:
    1. 左前足(FL)と右後ろ足(BR)を上げる
    2. 左前足(FL)と右後ろ足(BR)を戻す
    3. 右前足(FR)と左後ろ足(BL)を上げる
    4. 右前足(FR)と左後ろ足(BL)を戻す
  - 各フェーズ: 200ステップ（約0.8秒）
  - 上げる動作: 前脚はhipを後ろ向きに、後脚はhipを前向きに、kneeを曲げる
  - 位置が動かないように、上げる脚の反対側の対角線の脚でバランスを取る
- **バランス制御**:
  - 足踏み中も姿勢フィードバックゲインを2倍に設定
  - roll/pitchフィードバックを強化して位置を維持
- **結果**: 安定化後に自動的に足踏み動作を開始し、位置を維持しながら動作できるようになった

## コード構造

### 主要な変数・定数

```python
# 脚のジョイント構造
leg_joints = {
    'front_left': [0, 1, 2],      # abduction, hip, knee
    'front_right': [4, 5, 6],
    'back_left': [8, 9, 10],
    'back_right': [12, 13, 14]
}

# 立つ姿勢のジョイント角度（現在の設定 - 脚を閉じた状態で登場）
standing_angles = {
    'front_left': [0.0, 0.0, 0.5],      # abduction, hip, knee（脚を伸ばした状態）
    'front_right': [0.0, 0.0, 0.5],
    'back_left': [0.0, 0.0, 0.5],      # すべての脚を同じ角度で
    'back_right': [0.0, 0.0, 0.5]
}

# PD制御パラメータ
position_gain = 0.2  # 位置ゲイン（Kp）
velocity_gain = 1.0  # 速度ゲイン（Kd）

# 姿勢フィードバック制御のゲイン（過剰反応を防ぐため小さめに設定）
roll_feedback_gain = 0.01  # roll誤差に対するabduction調整ゲイン（0.05 → 0.01に削減）
pitch_feedback_gain = 0.005  # pitch誤差に対するhip調整ゲイン（0.02 → 0.005に削減）

# 立ち上がり制御用の変数
stability_confirmed = False  # 安定確認フラグ
standing_up_angles = None  # 立ち上がった後の目標角度
initial_standing_angles = None  # 立ち上がり開始時の初期角度（固定）
standing_up_start_step = None  # 立ち上がり開始ステップ
standing_up_duration = 2000  # 立ち上がりにかけるステップ数（極めてゆっくりと）

# 力とゲインの動的調整
# 立ち上がり開始後は、ずっと弱い力とゲインを維持（安定性を優先）
is_standing_up_or_after = (stability_confirmed and standing_up_start_step is not None and 
                          i - standing_up_start_step >= 0)
if is_standing_up_or_after:
    current_force = 10.0  # 通常の5%（弱い力で安定性を優先）
    current_position_gain = position_gain * 0.1  # 通常の10%
    current_velocity_gain = velocity_gain * 0.1  # 通常の10%
else:
    current_force = 200.0  # 通常の力
    current_position_gain = position_gain
    current_velocity_gain = velocity_gain
```

### リンク構造
- `hip0-3`: 股関節リンク
- `upper0-3`: 膝上リンク（大腿部）
- `lower0-3`: 膝下リンク（下腿部）
- `toe0-3`: つま先リンク

### リンクインデックスの取得方法
- リンク名から正しいリンクインデックスを取得する方法を実装済み
- `link_name_to_index`マッピングを使用して`upper0-3`と`lower0-3`を特定

## 実装済みの制御機能

### PD制御
- `positionGain=0.2`: 位置誤差に対する比例ゲイン
- `velocityGain=1.0`: 速度誤差に対する微分ゲイン
- より安定した姿勢制御を実現

### 姿勢フィードバック制御
- **左右バランス制御**: rollが負（左に傾く）場合、左側の脚の`abduction`を増やす
- **前後バランス制御**: pitchが正（前のめり）の場合、前脚の`hip`を後ろ向きに、後脚の`hip`を前向きに調整

### リセット機能
- 50ステップごとに姿勢をチェック
- 閾値: 位置移動20cm以上、高さ低下30%以上、姿勢傾き15度以上
- リセット統計を記録・表示

### 立ち上がり動作制御（現在：角度指定方式）
- **安定確認**: リセット無しで20ステップ経過したら安定とみなす
- **段階的な角度変更**: 線形補間により、初期角度から目標角度まで2000ステップかけてゆっくりと変更
- **初期角度の固定**: 立ち上がり開始時に`initial_standing_angles`として初期角度を固定保存
- **目標角度（最新）**: 
  - 前脚: `[0.0, 0.5, 1.7]` (abduction, hip=後ろ向き, knee=約97度) - 後傾姿勢のためhipを0.5に
  - 後脚: `[0.0, -0.2, 1.7]` (abduction, hip=前向き, knee=約97度) - 後傾姿勢のためhipを-0.2に
- **力とゲインの動的調整**: 立ち上がり開始後は、力20.0とゲイン0.2倍を維持（10.0/0.1倍から増加）
- **逆運動学の試行**: 試行したが失敗、現在は無効化（`use_ik_for_standing_up = False`）

### 左右対称制御
- **左右バランス調整**: 左右のabduction/hip角度のバランスを取る制御を追加
- **膝角度の左右バランス**: 左右の膝角度の差が0.2ラジアン以上の場合、バランスを取る
- **目的**: 左右が同時に目標に到達するようにする

### 足踏み動作制御
- **開始条件**: 安定化検知後に自動開始
- **動作パターン**: 4つのフェーズを繰り返す（各フェーズ200ステップ、約0.8秒）
  1. 左前足(FL)と右後ろ足(BR)を上げる
  2. 左前足(FL)と右後ろ足(BR)を戻す
  3. 右前足(FR)と左後ろ足(BL)を上げる
  4. 右前足(FR)と左後ろ足(BL)を戻す
- **バランス制御**: 足踏み中も姿勢フィードバックゲインを2倍に設定し、位置を維持

## ログから確認できる情報（最新：2026年1月13日 - 安定化検知機能追加後）

### 安定化検知時の状態（ステップ2190 - 立ち上がり完了から170ステップ後）
```
🎯 安定化検知！
姿勢: roll=-0.6° (変化率: 0.036°/10step), pitch=-2.3° (変化率: 1.100°/10step)
位置: Z=0.414m (変化率: 0.0083m/10step)
膝角度変化率: 1.740°/10step
接地状態: ✅ 4本すべて接地
安定化の兆候: Z位置の変化率が急に小さくなった (0.0221m → 0.0083m/10step)
```

### 安定化時の各脚の状態
```
front_left:
  ジョイント角度: abduction=-0.4°, hip=29.6°, knee=95.7°
  膝上リンク(upper0): pitch=-31.9° (ワールド座標系)
  膝下リンク(lower0): pitch=63.8° (ワールド座標系、座標系の向きにより前後が逆の可能性あり)
  接地状態: 接地(1点, 10.0N)
  → ✅ 逆関節（くの字）（膝角度=95.7°、GUIで確認すると「くの字」）

front_right:
  ジョイント角度: abduction=0.4°, hip=29.7°, knee=80.2°
  膝上リンク(upper1): pitch=-32.1° (ワールド座標系)
  膝下リンク(lower1): pitch=48.0° (ワールド座標系、座標系の向きにより前後が逆の可能性あり)
  接地状態: 接地(1点, 10.0N)
  → ⚠️ 中間形状（膝角度=80.2°）

back_left:
  ジョイント角度: abduction=-0.4°, hip=27.6°, knee=97.4°
  膝上リンク(upper2): pitch=-29.8° (ワールド座標系)
  膝下リンク(lower2): pitch=67.5° (ワールド座標系、座標系の向きにより前後が逆の可能性あり)
  接地状態: 接地(1点, 10.0N)
  → ✅ 逆関節（くの字）（膝角度=97.4°、GUIで確認すると「くの字」）

back_right:
  ジョイント角度: abduction=0.5°, hip=27.5°, knee=84.7°
  膝上リンク(upper3): pitch=-29.7° (ワールド座標系)
  膝下リンク(lower3): pitch=54.9° (ワールド座標系、座標系の向きにより前後が逆の可能性あり)
  接地状態: 接地(1点, 10.0N)
  → ⚠️ 中間形状（膝角度=84.7°）
```

**重要な発見**:
- 前脚（FL）と後脚（BL）が先に「逆関節（くの字）」形状になる（膝角度90度以上）
- 4本すべてが接地し、支持基底が確保される
- Z位置の変化率が急に小さくなる（高さが安定）
- これが「もじもじ期」から「安定期」への移行の鍵

### 現在の姿勢（最終状態 - 立ち上がり動作後）
```
位置: (-0.010, 0.014, 0.422)
姿勢: roll=-0.6°, pitch=-0.3°, yaw=1.3°
```

### リセット統計（3000ステップ中）✅ 大幅改善
```
総リセット回数: 1回（以前は29回）
原因別内訳:
  - 位置移動: 1回
```

### ジョイント角度（最終状態 - 立ち上がり動作後）
```
front_left: abduction=-0.8°, hip=26.4°, knee=97.9°（目標: 97.4°）✅ 目標達成！
front_right: abduction=0.1°, hip=28.7°, knee=91.0°（目標: 97.4°）⚠️ 目標に近いが未到達
back_left: abduction=-0.1°, hip=28.3°, knee=98.1°（目標: 97.4°）✅ 目標達成！
back_right: abduction=0.4°, hip=28.7°, knee=92.8°（目標: 97.4°）⚠️ 目標に近いが未到達
```

**改善点**: 
- ✅ 前脚（FL）が97.9°に到達（目標達成！）
- ✅ 後脚（BL）が98.1°に到達（目標達成！）
- ✅ 前脚（FR）が91.0°まで到達（目標に近い）
- ✅ 後脚（BR）が92.8°まで到達（目標に近い）
- ✅ 安定化後も膝角度は改善を続けている（特にFRとBRが大きく改善）

### リンク角度（最終状態）
```
膝上リンク（upper0-3）: pitch=-15.6°～-22.2°（後ろ向きに傾いている）
膝下リンク（lower0-3）: pitch=-5.6°～-5.7°（後ろ向きだが、膝の角度が小さい）
```

**注意**: 立ち上がりが進んでいないため、膝の角度が小さく、目標の逆関節形状に到達していない。

## 技術的な発見

### リンクインデックスの取得
- **問題**: 当初、`thigh_link = hip_joint + 1`という仮定で取得していたが、実際にはリンク名から取得する必要があった
- **解決**: リンク名マッピング（`link_name_to_index`）を作成し、`upper0-3`と`lower0-3`を正しく特定

### 姿勢の安定化の鍵（2026年1月13日発見）
- **重要な発見**: 初期姿勢の設定方法が安定性に大きく影響する
- **解決方法**: 脚を閉じた状態（knee=0.5ラジアン）で登場させ、そのまま放置することで完璧に安定
- **初期位置**: 地面から10cm上（`initial_pos = [0, 0, 0.1]`）
- **安定化処理**: 姿勢設定後、100ステップ物理シミュレーションを進めて安定させる
- **結果**: リセット0回、姿勢完璧に水平

### 安定化のメカニズム（2026年1月13日解明）
- **もじもじ期から安定期への移行**: 立ち上がり完了後、約170ステップ（約0.7秒）で安定化
- **安定化のタイミング**: ステップ2190（立ち上がり完了から170ステップ後）
- **安定化の兆候**:
  1. Z位置の変化率が急に小さくなる（0.0221m → 0.0083m/10step）
  2. 4本すべてが接地し、支持基底が確保される
  3. 前脚（FL）と後脚（BL）が先に「逆関節（くの字）」形状になる（膝角度90度以上）
- **安定化の理由**:
  1. **PD制御の収束**: 目標角度への誤差が小さくなり、トルクが小さくなる
  2. **物理的な減衰**: 減衰パラメータ（線形減衰0.5、角減衰0.5、ジョイントダンピング0.5）により振動が減衰
  3. **姿勢フィードバック制御の安定化**: 姿勢が安定し、フィードバック調整が小さくなる
  4. **接地状態の安定化**: 4本すべてが接地し、支持基底が広がる
  5. **逆関節（くの字）形状の実現**: 膝角度が90度以上になり、支持基底が広がり、重心が安定
- **安定化後の改善**: 安定化後も膝角度は改善を続け、最終的にはすべての脚が90度以上に到達

### 初期姿勢設定の重要性
- 脚を伸ばした状態で低い位置に配置すると、地面に干渉して跳ね上がる
- 脚を閉じた状態で適切な高さに配置すると、安定して立つことができる
- 高さ調整を削除し、そのまま放置することで安定性が向上

### 立ち上がり動作の実装（2026年1月13日）
- **段階的な角度変更**: 線形補間により、初期角度（knee=0.5ラジアン）から目標角度（knee=1.7ラジアン）まで2000ステップかけて変更
- **初期角度の固定化**: 立ち上がり開始時に`initial_standing_angles`として初期角度を固定保存（重要：毎回変わる`standing_angles`ではなく、固定値を使用）
- **力とゲインの動的調整**: 立ち上がり開始後は、弱い力（10.0）と弱いゲイン（0.1倍）を維持して安定性を優先
- **問題**: 力が弱すぎて目標角度に到達できない可能性が高い

### 判定ロジックの問題（2026年1月13日 - 解決済み）
- **問題**: 膝下リンクのpitch判定が座標系の向きにより誤判定される
- **原因**: `getLinkState`で取得した姿勢はワールド座標系での姿勢であり、膝下リンクのローカル座標系が膝上リンクとは異なる向きに定義されている可能性
- **解決方法**: 膝角度（90度以上）を基準に判定することで、GUIで確認した「くの字」形状を正しく判定
- **結果**: 安定化検知時に、各脚の状態を正しく判定できるようになった

## 次のステップ

### 優先度：高（緊急）
1. **立ち上がり動作の修正** - 進行中（2026年1月13日）
   - **問題**: 目標knee角度（97.4°）に到達しない（実際は10.2°～16.6°）
   - **対応方針**:
     - `current_force`を10.0から15.0～20.0に増やす
     - ゲインを0.1倍から0.15～0.2倍に増やす
     - 立ち上がり中の進行度をログ出力して確認
     - リセットの閾値を一時的に緩和（立ち上がり中はリセットを抑制）
   - **確認事項**:
     - 線形補間が正しく動作しているか（progressの計算）
     - 力が弱すぎて目標角度に到達できないか
     - リセットが立ち上がりを妨げていないか

2. ✅ **姿勢の安定化** - 完了（2026年1月13日）
   - 脚を閉じた状態で登場させる方法で完璧に安定
   - リセット0回、姿勢完璧に水平

### 優先度：中
3. **判定ロジックの改善**
   - 膝下リンクのpitch判定ロジックを見直し
   - 実際には逆関節になっているのに警告が出る問題を修正

### 優先度：中
4. **姿勢フィードバック制御の最適化**
   - 現在は安定しているが、より効果的なバランス制御を実現
   - `roll_feedback_gain`と`pitch_feedback_gain`の値を調整（現在は小さめに設定）

5. **PD制御パラメータの最適化**
   - `positionGain`と`velocityGain`の値を最適化
   - 現在は安定しているが、より良い制御を実現

### 優先度：低
6. **足踏み動作の実装**
7. **前進動作の実装**
8. **方向転換の実装**

## 技術的な注意点

### 逆関節ロボットの特徴
- **hip角度**: 正の値 = 後ろ向き、負の値 = 前向き
- **knee角度**: 大きい値（2.0-2.5ラジアン）で後ろ向きに曲がる
- **目標形状**: 膝上が後ろ向きに傾き、膝下も後ろ向きに曲がる「逆くの字」

### 角度の範囲
- abduction: 通常 -0.43 ～ 0.43 ラジアン
- hip: 通常 -3.142 ～ 3.142 ラジアン
- knee: 通常 0.0 ～ 3.142 ラジアン

### PyBulletの制御方法
- `resetJointState()`: ジョイントを直接リセット（初期設定用）
- `setJointMotorControl2()`: ジョイントを目標角度に制御（継続制御用）
  - `POSITION_CONTROL`: 位置制御モード
  - `positionGain`: PD制御の比例ゲイン
  - `velocityGain`: PD制御の微分ゲイン
  - `force`: 最大トルク（現在200.0に設定）

### リンクの取得方法
- リンク名からインデックスを取得: `link_name_to_index`マッピングを使用
- `getLinkState()`でリンクの姿勢を取得
- `getEulerFromQuaternion()`でオイラー角に変換

## テスト方法

### 実行コマンド
```bash
cd /root/LearnPyBullet
python srcs/p08_vision60.py
```

### 確認ポイント
1. ロボットが立っているか
2. リセット回数が減っているか（PD制御と姿勢フィードバックの効果）
3. 姿勢が安定しているか（「ぴくぴく」動作が減っているか）
4. 各脚の角度が適切か（ログで確認）
5. 膝下リンクが後ろ向きになっているか（ログで確認）

## トラブルシューティング

### ロボットが転倒する場合
- ベースの高さを調整（`target_height`）
- ジョイント角度を調整
- 姿勢制御の力（`force`）を増やす
- PD制御パラメータを調整

### リセットが頻繁に発生する場合
- 姿勢フィードバック制御のゲインを調整
- PD制御パラメータを調整
- リセットの閾値を緩和（一時的）

### 膝下が前向きのままの場合
- knee角度を増やす（2.3 → 2.5-2.8など）
- hip角度も調整
- 角度の組み合わせを試行錯誤

### リンク情報が取得できない場合
- リンク名マッピング（`link_name_to_index`）を確認
- `getLinkState()`のエラーハンドリングを確認

## 参考情報

### Vision60の実機仕様
- 逆関節ロボット（膝が後ろ向きに曲がる）
- 4本の脚、各脚に3つの可動ジョイント（abduction, hip, knee）
- 高度な制御システム（ブラインドモード制御、階層型制御）

### PyBulletのPD制御
- `positionGain`: 位置誤差に対する比例ゲイン（Kp）
- `velocityGain`: 速度誤差に対する微分ゲイン（Kd）
- 制御トルク: `τ = positionGain * (targetPosition - currentPosition) + velocityGain * (targetVelocity - currentVelocity)`

## 次のセッションで確認すべきこと（最新：2026年1月15日）

### 優先度：高
1. ✅ **足踏み動作の修正と最適化** - 完了（2026年1月15日）
   - ✅ 股関節の回転方向の修正（BRとBLのhip回転方向を修正）
   - ✅ 角度調整量の最適化（hip: 0.4→0.3、knee: 0.3→0.5）
   - ✅ 足踏み速度の調整（2400→240ステップ、1サイクル2秒）
   - ✅ 色変更のタイミング同期
   - ✅ ログ分析による動作確認
2. **歩行動作の実装** - 次のステップ
   - 足踏み動作を基に、前進・後退・方向転換などの歩行動作を実装
   - 重心移動と足の着地タイミングの制御
   - 歩行速度とステップ長の調整

2. ✅ **姿勢の安定性** - 大幅改善（リセット0回、roll=-0.1°, pitch=-0.4°で非常に安定）
3. ✅ **物理パラメータの最適化** - 完了（ジョイント制御の力を30Nに制限、タイムステップを1/480秒に設定）
4. ✅ **リセット処理の改善** - 完了（位置を初期位置に戻す、速度をリセット）

### 優先度：中
5. ✅ **左右対称制御** - 改善済み（左右が同時に目標に到達するようにする）
6. ✅ **足踏み動作** - 実装・最適化完了（対角線の脚を交互に上げ下げ、股関節回転方向修正、速度調整、色変更同期）
7. ✅ **ログ表示の改善** - 完了（各モジュール名が正しく表示されるように）
8. ✅ **色変更機能** - 実装済み（状態に応じて色を変更、足踏み1サイクル完了時にオリジナルの色に戻す）
9. **判定ロジックの改善** - 膝下リンクのpitch判定を見直す
10. **長時間実行での安定性** - 3000ステップで安定性を確認済み（リセット0回）
11. **外部擾乱への耐性** - 軽い押しなどに対する反応を確認

## 最新のコード変更履歴（2026年1月13日）

### 安定化検知機能の追加（2026年1月13日 - 最新）
- **追加**: 立ち上がり完了後の安定化検知機能
  - 立ち上がり完了後（progress >= 1.0）から10ステップごとに安定性をチェック
  - 姿勢の変化率（roll/pitch）、位置の変化率（Z方向）、膝角度の変化率を監視
  - 急に安定した瞬間（変化率が急に小さくなる）を検知
- **追加**: 安定化検知時の各脚の詳細状態ログ出力
  - 各脚のジョイント角度（abduction, hip, knee）
  - 膝上・膝下リンクの角度（ワールド座標系）
  - 接地状態（接地点数、接触力）
  - 逆関節形状の判定（膝角度90度以上で判定）
- **修正**: 座標系の問題を解決
  - 膝下リンクのpitch判定が座標系の向きにより誤判定される問題を発見
  - 膝角度（90度以上）を基準に判定することで、GUIで確認した「くの字」形状を正しく判定
- **結果**: 
  - 安定化のタイミングを正確に検知できるようになった（ステップ2190）
  - 安定化の理由を解明（前脚FLと後脚BLが先に「逆関節（くの字）」形状になり、4本すべてが接地することで安定化）

### 立ち上がり動作の実装（初回）
- **追加**: `initial_standing_angles`変数（立ち上がり開始時の初期角度を固定保存）
- **修正**: 線形補間で固定された初期角度を使用（毎回変わる`standing_angles`ではなく）
- **実装**: 段階的な角度変更（2000ステップかけてゆっくりと）
- **実装**: 力とゲインの動的調整（立ち上がり後は弱い力で維持）

### 立ち上がり動作の修正（2026年1月13日 - 第1弾）
- **修正**: `current_force`を10.0から20.0に増加（目標角度に到達するため）
- **修正**: `current_position_gain`を`position_gain * 0.1`から`0.2`に増加
- **修正**: `current_velocity_gain`を`velocity_gain * 0.1`から`0.2`に増加
- **追加**: 立ち上がり中の進行度ログ出力（100ステップごとにknee角度を表示）
- **追加**: 立ち上がり中のリセット閾値緩和（姿勢傾きの閾値を15度→25度に）

### 前のめり問題の修正（2026年1月13日 - 第2弾）
- **修正**: 立ち上がり目標角度を調整（後傾姿勢で立ち上がる）
  - 前脚のhip: 0.3→0.5に増加（後ろ向きに）
  - 後脚のhip: 0.4→-0.2に変更（前向きに）
- **追加**: 立ち上がり中の姿勢フィードバック強化（pitchフィードバックゲインを2倍に）

### 左右バランス問題の修正（2026年1月13日 - 第3弾）
- **追加**: 立ち上がり中のrollフィードバック強化（rollフィードバックゲインを2倍に）
- **追加**: 位置フィードバック制御（X方向の移動を抑制、右前への傾きを防ぐ）
  - `position_feedback_gain = 0.001`（位置誤差に対するabduction調整ゲイン）
  - X方向に5cm以上移動した場合、左右の脚のabductionを調整

### 右前への傾き修正と接地状態に基づく修正（2026年1月13日 - 第4弾）
- **追加**: 右前への傾きを修正するためのknee角度直接調整
  - `tilt_correction_knee_gain = 0.03`（傾き修正用のknee調整ゲイン）
  - X方向に右へ移動している場合、右側の脚のkneeを伸ばす、左側の脚のkneeを曲げる
  - rollが右に傾いている場合、右側の脚のkneeを伸ばす、左側の脚のkneeを曲げる
  - pitchが前のめりの場合、前脚のkneeを伸ばす、後脚のkneeを曲げる
- **追加**: 接地状態に基づく修正制御
  - `contact_feedback_gain = 0.02`（接地状態に基づくknee調整ゲイン）
  - `contact_hip_feedback_gain = 0.01`（接地状態に基づくhip調整ゲイン）
  - 浮上している脚または弱い接地の脚を下げる（hipとkneeを調整）
  - 特に右後ろ足（BR）が浮上している場合の特別な修正（より積極的に修正）

### 姿勢不安定の原因分析と修正強化（2026年1月13日 - 第5弾、最新）
- **問題分析**: ログから以下の問題を特定
  1. **後脚（特にBL）の膝角度が目標に到達しない**: BL=37.6°（目標97.4°に対して-39.2°の誤差）
  2. **BRの浮上が継続**: ステップ1420以降、BRが浮上し続ける
  3. **右前への傾きが継続**: X方向に右へ移動、rollが右に傾く
  4. **修正制御の効果が不十分**: ゲインが小さすぎる可能性
- **実施した修正**:
  1. **接地状態の検知頻度を増加**: 10ステップごと→毎ステップ（即座に修正するため）
  2. **ゲインを大幅に増加**:
     - `tilt_correction_knee_gain`: 0.03 → 0.1（約3.3倍）
     - `contact_feedback_gain`: 0.02 → 0.05（2.5倍）
     - `contact_hip_feedback_gain`: 0.01 → 0.02（2倍）
  3. **後脚（BL, BR）の膝角度が目標に到達しない問題を修正**:
     - 後脚の膝角度が目標より0.3ラジアン（約17度）以上小さい場合、接地している場合は膝角度を増やす
     - 浮上している場合は、まず接地させるためにkneeを曲げる
  4. **傾き修正の閾値を緩和**:
     - roll修正: 5度以上→3度以上
     - pitch修正: 3度以上→2度以上
     - X方向修正: 5cm以上→3cm以上
  5. **修正ゲインを増加**:
     - roll/pitch修正: 0.01倍→0.02倍
     - X方向修正: 2倍に増加
     - 接地状態修正: 3倍～5倍に増加

### 跳ねる問題の解決（2026年1月13日 - 第6弾、最新）
- **問題**: ロボットが「ぴょんぴょん」跳ねる、実機のような重量感・安定感がない
- **原因分析**:
  1. 質量が軽すぎる（URDFのデフォルト値が実機より軽い可能性）
  2. ダンピングが不足している（線形・角減衰がない）
  3. 反発係数が高い（地面との反発で跳ねる）
  4. ジョイントのダンピングが不足している
- **実施した修正**:
  1. **ベースリンクの質量を増加**: 25kgに設定（実機に近い値）
  2. **線形・角減衰を追加**: `linearDamping=0.5`, `angularDamping=0.5`（跳ねるのを抑制）
  3. **反発係数を低減**: `restitution=0.1`（低反発、跳ねにくい）
  4. **摩擦を増加**: `lateralFriction=1.0`（滑りにくくする）
  5. **ジョイントダンピングを追加**: `jointDamping=0.5`（動きを安定化）
  6. **地面の反発係数も低減**: 地面の`restitution=0.1`に設定
  7. **PD制御のvelocityGainを増加**: 1.0 → 2.0（動きを安定化）

### 質量と力のバランス調整（2026年1月13日 - 第7弾）
- **問題**: 質量を25kgに増やした結果、力が足りず立ち上がれなくなった
  - 膝角度が目標の97.4°に全く到達しない（FL=39.3°, FR=28.3°, BL=-0.0°, BR=2.7°）
  - 特に後脚（BL, BR）が全く伸びていない
- **実施した修正**:
  1. **質量を調整**: 25kg → 15kg（重すぎると立ち上がれないため、適度な値に調整）
  2. **力を大幅に増加**: 20.0 → 50.0（質量15kgに対応、約2.5倍）
  3. **ゲインを増加**: 
    - `position_gain`: 0.2倍 → 0.5倍
    - `velocity_gain`: 0.2倍 → 0.5倍
  - 質量が増えた分、力とゲインも比例して増やす必要がある

### 左右対称制御の改善（2026年1月13日 - 最新）
- **問題**: 左側（FL, BL）が先に逆関節になるのに対して、右側（FR, BR）が後から追いつく
- **原因**: 右脚が左脚に依存する制御（右脚の角度を左脚の逆にする処理）により、左右が同時に目標に到達できない
- **実施した修正**:
  1. **左右バランス調整の追加**: 左右のabduction/hip角度のバランスを取る制御を追加（行605-644）
  2. **膝角度の左右バランス調整**: 左右の膝角度の差が0.2ラジアン以上の場合、バランスを取る（行855-900）
  3. **左右対称制御**: 右脚を左脚に依存させるのではなく、左右対称に制御
- **結果**: 左右が同時に目標に到達するようになり、安定性が向上

### 足踏み動作の実装（2026年1月13日 - 最新）
- **目的**: 位置が動かないように、対角線の脚を交互に上げ下げする動作
- **実装内容**:
  1. **変数定義**: 足踏み動作用の変数を追加（行232-238）
     - `stabilization_detected`: 安定化が検知されたかどうか
     - `stepping_started`: 足踏み動作を開始したかどうか
     - `stepping_phase`: 足踏みのフェーズ（0-3）
     - `base_standing_angles_for_stepping`: 足踏み開始時の基本姿勢角度
  2. **制御ロジック**: 足踏み動作の制御を実装（行549-640）
     - 安定化検知後に自動開始
     - 4つのフェーズを繰り返す（各フェーズ200ステップ、約0.8秒）
     - 対角線の脚を交互に上げ下げ
  3. **バランス制御**: 足踏み中も姿勢フィードバックゲインを2倍に設定し、位置を維持
- **結果**: 安定化後に自動的に足踏み動作を開始し、位置を維持しながら動作できるようになった

### リセット処理の改善（2026年1月15日）
- **問題**: リセット時に位置を修正した際、物理エンジンで急激な上昇（約0.2m）が発生していた
- **解決方法**:
  1. X, Y座標を初期位置に戻し、Z座標（高さ）は現在の高さを維持
  2. ベースの速度と角速度をゼロにリセット（`resetBaseVelocity`）
  3. すべてのジョイントの速度をゼロにリセット（角度は維持）
- **結果**: リセットがスムーズになり、跳ね上がりが解消

### 物理パラメータの最適化（2026年1月15日）
- **問題**: ジョイント制御の力が200Nと大きすぎて、物理法則を無視した動き（1本足や2本足だけで立つ）が発生
- **解決方法**:
  1. ジョイント制御の力を200N → 30Nに削減（15kgのロボットに対して現実的な値）
  2. タイムステップを1/240秒（約4.17ms）→ 1/480秒（約2.08ms）に細かく設定
  3. PyBulletのタイムステップを明示的に設定（`p.setTimeStep()`）
- **結果**: 物理シミュレーターとして信頼性の高い動作になり、不自然な動きが解消

### 足踏み動作の改善（2026年1月15日）
- **問題**: 足踏み中に姿勢が大きく傾き、1本足や2本足だけで立つ不自然な動きが発生
- **解決方法**:
  1. 足踏み動作の角度調整量を小さく（hip: 0.4ラジアン→0.15ラジアン、knee: 0.3ラジアン→0.1ラジアン）
  2. 足踏み中は姿勢フィードバック制御を無効化（足踏み動作と競合しないように）
  3. 足踏み中の接地状態をログに追加
- **結果**: 足踏み動作がより安定したが、時間が短すぎる課題が残る

### ログ表示の改善（2026年1月15日）
- **問題**: すべてのログが`p08_vision60.logger`として表示されていた
- **解決方法**: `Logger`クラスの各メソッドに`logger`パラメータを追加し、呼び出し元から適切なロガーを渡すように変更
- **結果**: 各モジュール名（`standing_control`, `stepping_control`, `main`など）が正しく表示されるように

### 色変更機能の追加（2026年1月15日）
- **実装内容**:
  1. 状態に応じてロボットの色を変更する機能を追加
     - 通常時: 青系 `[0.3, 0.5, 0.8, 1.0]`
     - 立ち上がり中: オレンジ系 `[0.9, 0.6, 0.2, 1.0]`
     - 足踏み中: 緑系 `[0.2, 0.8, 0.3, 1.0]`
     - 終了待機中: 紫系 `[0.8, 0.2, 0.8, 1.0]`
  2. オリジナルの色（半透明）を保存し、足踏み1サイクル完了時に戻す機能
- **目的**: 足踏み中と終了待機中を視覚的に判別できるように

### 足踏み動作の修正と最適化（2026年1月15日 - 最新）
- **修正1: 股関節の回転方向の修正**
  - `stepping_control.py`: BRとBLのhip回転方向を修正（`-=` → `+=`）
  - フェーズ0（FL+BRを上げる）: BRのhip回転方向を修正
  - フェーズ2（FR+BLを上げる）: BLのhip回転方向を修正
  - 実機の動作に合わせて、両脚とも股関節を後ろ側に回すように変更
- **修正2: 角度調整量の最適化**
  - 股関節の角度: `0.4` → `0.3`ラジアン（約17度、水平移動を抑制）
  - 膝の角度: `0.3` → `0.5`ラジアン（約29度、垂直上昇を増やす）
- **修正3: 足踏み速度の調整**
  - `config.py`: `STEPPING_PHASE_DURATION`: 2400 → 240ステップ
  - 1サイクル（4フェーズ）: 20秒 → 2秒
  - 「タッタッタッタッ」というリズムで動作
- **修正4: 色変更のタイミング同期**
  - `stepping_control.py`: 各フェーズの開始時に色を変更
  - フェーズ0, 2（足を上げる）: 緑色
  - フェーズ1, 3（足を戻す）: オリジナルの色（グレー）
- **結果**: 
  - ✅ 対角線の脚が適切に浮上・接地している
  - ✅ 足先が垂直方向に上がっている
  - ✅ 姿勢が安定している
  - ✅ フェーズ遷移が正しく動作している
  - ✅ 色変更がタイミングと同期している
  - ✅ ログ分析により、動作が正常であることを確認

### 現在の設定値（最新 - 2026年1月15日）
- `standing_up_duration = 2000`（立ち上がりにかけるステップ数）
- `total_simulation_steps = 3000`（総シミュレーションステップ数）
- `TIME_STEP = 1.0 / 480.0`（約2.08ms、物理シミュレーションの精度向上）
- `current_force = 30.0`（通常時の力、物理的に現実的な値に制限）
- `STANDING_UP_FORCE = 50.0`（立ち上がり中の力）
- `current_position_gain = position_gain * 0.5`（立ち上がり中の位置ゲイン）
- `current_velocity_gain = velocity_gain * 0.5`（立ち上がり中の速度ゲイン）
- `STEPPING_PHASE_DURATION = 240`（各フェーズの継続時間、0.5秒/フェーズ、2秒/サイクル）
- **足踏み動作の角度調整量（最新）**:
  - 股関節（hip）: 0.3ラジアン（約17度、後ろ向きに回す）
  - 膝（knee）: 0.5ラジアン（約29度、曲げる）
- 立ち上がり中の姿勢傾きリセット閾値: 25度（通常は15度）
- **立ち上がり目標角度（最新 - 従来方式に戻す）**:
  - 前脚: `[0.0, 0.5, 1.7]` (abduction, hip=後ろ向き, knee=約97度) - hipを0.3→0.5に増加
  - 後脚: `[0.0, -0.2, 1.7]` (abduction, hip=前向き, knee=約97度) - hipを0.4→-0.2に変更（後傾姿勢）
- **立ち上がり中の姿勢フィードバック**:
  - pitchフィードバックゲインを2倍に増加（前のめり抑制）
  - rollフィードバックゲインを2倍に増加（左右バランス強化）
- **位置フィードバック**: `position_feedback_gain = 0.001`（X方向の移動を抑制、右前への傾きを防ぐ）
- **傾き修正用knee調整**: `tilt_correction_knee_gain = 0.1`（右前への傾きを修正するためのknee角度直接調整、0.03→0.1に増加）
- **接地状態フィードバック**: `contact_feedback_gain = 0.05`（浮上している脚を下げるためのknee調整、0.02→0.05に増加）
- **接地状態フィードバック（hip）**: `contact_hip_feedback_gain = 0.02`（浮上している脚を下げるためのhip調整、0.01→0.02に増加）
- **接地状態の検知頻度**: 毎ステップ（10ステップごと→毎ステップに変更、即座に修正するため）
- **逆運動学**: `use_ik_for_standing_up = False`（無効化、従来の角度指定方式を使用）
- **物理パラメータ（最新）**:
  - ベースリンク質量: 15.0kg（25kg→15kgに調整、重すぎると立ち上がれない）
  - 線形減衰: 0.5（跳ねるのを抑制）
  - 角減衰: 0.5（回転の跳ねを抑制）
  - 反発係数: 0.1（低反発、跳ねにくい）
  - 横摩擦: 1.0（滑りにくくする）
  - ジョイントダンピング: 0.5（動きを安定化）
  - PD制御velocityGain: 2.0（1.0→2.0に増加、動きを安定化）
- **力とゲイン（最新）**:
  - 立ち上がり中の力: 50.0（20.0→50.0に増加、質量15kgに対応）
  - 立ち上がり中のpositionGain: 0.5倍（0.2倍→0.5倍に増加）
  - 立ち上がり中のvelocityGain: 0.5倍（0.2倍→0.5倍に増加）

### 次の確認事項
- ✅ 目標knee角度（97.4°）に近づいている（86.8°まで到達） - 改善確認済み
- ✅ 立ち上がり中の進行度ログで、角度が段階的に増加している - 確認済み
- ✅ 逆運動学の試行と失敗を確認 - 従来方式に戻す
- ✅ 安定化検知機能の実装 - 完了
- ✅ 安定化の理由の解明 - 完了（前脚FLと後脚BLが先に「逆関節（くの字）」形状になり、4本すべてが接地することで安定化）
- ✅ 座標系の問題の解決 - 完了（膝角度を基準に判定することで正しく判定）
- ✅ 左右対称制御の改善 - 完了（左右が同時に目標に到達するようにする）
- ✅ 足踏み動作の実装 - 完了（対角線の脚を交互に上げ下げ）
- 🔄 前脚（FR）と後脚（BR）の膝角度を目標に到達させる（現在91.0°、92.8°、目標97.4°）
- 🔄 安定化後の改善をさらに促進する方法の検討
- 🔄 足踏み動作が正常に動作しているか（位置が動かないか）
- 🔄 左右が同時に逆関節になっているか
- 🔄 安定化検知が正確に動作しているか

## 引き継ぎ事項（2026年1月15日）

### 最新の状態（2026年1月15日）
- **リセット回数**: 0回（3000ステップ中）✅ 完璧に安定
- **姿勢**: roll=-0.1°, pitch=-0.4°（非常に安定）
- **位置**: (0.102, 0.004, 0.423)（安定）
- **動作**: 非常に安定しており、物理シミュレーターとして信頼性が高い

### 最新の改善内容（2026年1月15日）
1. **リセット処理の改善**: 位置を初期位置に戻す、速度をリセット
2. **物理パラメータの最適化**: ジョイント制御の力を30Nに制限、タイムステップを1/480秒に設定
3. **足踏み動作の改善**: 角度調整量を小さく、姿勢フィードバック制御を無効化
4. **ログ表示の改善**: 各モジュール名が正しく表示されるように
5. **色変更機能の追加**: 状態に応じて色を変更（青→オレンジ→緑→紫）

### 現在の課題（2026年1月15日）
- **足踏み時間が短すぎる**: 足踏み動作が十分に実行されていない可能性
  - 現在の設定: 600ステップ/フェーズ（約2.5秒/フェーズ、約10秒/サイクル）
  - タイムステップ: 1/480秒（約2.08ms）
  - 次のステップ: 足踏み時間をさらに長くする（800-1000ステップ/フェーズ）を検討

### コードの重要な部分（最新 - 2026年1月15日）
- **リセット処理**: `agents/p08_vision60/my_agent/utils/reset_handler.py`
  - `_reset_pose()`: 位置を初期位置に戻す、速度をリセット
- **物理パラメータ**: `agents/p08_vision60/my_agent/utils/config.py`
  - `TIME_STEP = 1.0 / 480.0`: タイムステップ
  - `agents/p08_vision60/my_agent/utils/joint_control.py`
  - `current_force = 30.0`: 通常時の力（物理的に現実的な値）
- **足踏み動作**: `agents/p08_vision60/my_agent/utils/stepping_control.py`
  - 角度調整量: hip=0.15、knee=0.1（小さく設定）
  - 姿勢フィードバック制御を無効化
- **色変更機能**: `agents/p08_vision60/my_agent/utils/robot_model.py`
  - `change_robot_color()`: 色を変更
  - `restore_original_colors()`: オリジナルの色に戻す

## 引き継ぎ事項（2026年1月13日）

### 重要な変更履歴
1. **逆運動学の試行と失敗**:
   - `p.calculateInverseKinematics()`を使用した逆運動学制御を実装
   - 完全に失敗し、従来の角度指定方式に戻す
   - コードは残しているが、`use_ik_for_standing_up = False`で無効化

2. **現在の制御方式**:
   - **角度指定方式**: 各脚のジョイント角度（abduction, hip, knee）を直接指定
   - **立ち上がり目標角度**:
     - 前脚: `[0.0, 0.5, 1.7]` (abduction, hip=後ろ向き, knee=約97度)
     - 後脚: `[0.0, -0.2, 1.7]` (abduction, hip=前向き, knee=約97度)
   - **線形補間**: 初期角度から目標角度まで2000ステップかけてゆっくりと変更

3. **左右対称制御の改善**:
   - 左右のabduction/hip角度のバランス調整を追加
   - 左右の膝角度のバランス調整を追加（左右差が0.2ラジアン以上の場合）
   - 左右が同時に目標に到達するようにする

4. **足踏み動作の実装**:
   - 安定化検知後に自動開始
   - 対角線の脚を交互に上げ下げ（4つのフェーズを繰り返す）
   - 各フェーズ200ステップ（約0.8秒）
   - 位置が動かないようにバランス制御を実装

5. **現在の問題点**:
   - 立ち上がり中に右前へ傾く（X方向に右へ移動、pitchが前のめり）
   - 立ち上がり後（ステップ1900以降）にリセットが頻発
   - 後脚（特にBL）の膝角度が目標に到達しない（38°程度で止まる）

6. **実装済みの改善策**:
   - 立ち上がり中のroll/pitchフィードバックゲインを2倍に増加
   - 位置フィードバック制御（X方向の移動を抑制）
   - 力とゲインの増加（force=50.0, position_gain=0.5, velocity_gain=0.5）
   - 左右対称制御の改善
   - 足踏み動作の実装

### コードの重要な部分
- **安定化検知機能**: 行834-1120（立ち上がり完了後の安定化検知）
- **左右対称制御**: 行605-644（abduction/hip角度の左右バランス調整）、行855-900（膝角度の左右バランス調整）
- **足踏み動作制御**: 行549-640（足踏み動作の制御）
- **足踏み動作用の変数**: 行232-238（`stabilization_detected`, `stepping_started`, `stepping_phase`, `base_standing_angles_for_stepping`）

### 次のセッションで試すべきこと（優先順位順）

#### 優先度：高
1. **足踏み動作の改善**:
   - 位置が動かないように、バランス制御をさらに強化
   - 足を上げる高さを調整（現在はhip/knee角度で制御）
   - 足踏み中の姿勢フィードバックを最適化

2. **左右対称制御の最適化**:
   - 左右のバランス調整ゲインを最適化
   - 左右が同時に目標に到達することを確認

3. **後脚（BL）の膝角度が目標に到達しない問題の解決**:
   - **問題**: BLの膝角度が38°～41°で止まり、目標の97.4°に到達しない
   - **試すべきこと**:
     - BLのhip角度を調整（現在-0.2、もっと前向きにする？）
     - BLのabduction角度を調整（現在0.0、外側に開く？）
     - BLだけに特別な力やゲインを適用する
     - 後脚の目標角度を段階的に変更（最初は小さく、徐々に大きく）

2. **右前への傾きの抑制**:
   - **問題**: X方向に右へ移動、pitchが前のめり、rollも右に傾く
   - **試すべきこと**:
     - 位置フィードバックゲインを増加（現在0.001、0.002～0.005に？）
     - rollフィードバックゲインをさらに増加（現在2倍、3倍に？）
     - 前脚（FL, FR）のhip角度を調整（現在0.5、もっと後ろ向きに？）
     - 後脚（BL, BR）のhip角度を調整（現在-0.2、もっと前向きに？）

#### 優先度：中
3. **リセット条件の見直し**:
   - **問題**: ステップ1900以降、リセットが頻発
   - **試すべきこと**:
     - 立ち上がり中のリセット閾値をさらに緩和（姿勢傾き25°→30°、位置移動20cm→25cm）
     - リセット条件の判定タイミングを調整（50ステップごと→100ステップごと）
     - 立ち上がり中はリセットを完全に無効化するオプションを追加

4. **接地状態の安定化**:
   - **問題**: FLが1点接地（10.0N）と弱い、BRが浮上し始める
   - **試すべきこと**:
     - 各脚の接地力を均等にする制御を追加
     - 浮上している脚を検出して、その脚の角度を調整
     - 接地力の分布をログ出力して分析

#### 優先度：低
5. **ログの分析と可視化**:
   - 立ち上がり中のログを詳細に分析
   - どの脚がどのタイミングで浮上するか確認
   - 接地力の分布をグラフ化（将来の改善のため）

6. **立ち上がりの進行速度の調整**:
   - 現在2000ステップ、もっとゆっくり（3000ステップ）または速く（1500ステップ）試す
   - 段階的に進行速度を変える（最初はゆっくり、後半は速く）

### コードの重要な部分
- **逆運動学のコード**: 行133-137（変数定義）、行178-212（初期化、無効化されているが将来の参考のために残している）、行217-266（逆運動学計算ループ、現在は使用されない）
- **角度指定方式**: 行178-186（`standing_up_angles`の設定）
- **立ち上がり制御ループ**: 行269-349（従来の角度指定方式、現在使用中）
- **姿勢フィードバック**: 行385-416（roll/pitchフィードバック、位置フィードバック）
- **安定化検知機能**: 行834-1120（立ち上がり完了後の安定化検知）
- **左右対称制御**: 行605-644（abduction/hip角度の左右バランス調整）、行855-900（膝角度の左右バランス調整）
- **足踏み動作制御**: 行549-640（足踏み動作の制御）
- **足踏み動作用の変数**: 行232-238（`stabilization_detected`, `stepping_started`, `stepping_phase`, `base_standing_angles_for_stepping`）

### 現在のログから見える問題点（2026年1月13日）
1. **後脚（BL）の膝角度が目標に到達しない**:
   - 目標: 97.4°（1.7ラジアン）
   - 実際: 38°～41°程度で止まる
   - 前脚（FL, FR）は80°～90°まで到達している
   - 後脚（BR）も80°程度まで到達しているが、BLだけが遅れている

2. **立ち上がり中の右前への傾き**:
   - X方向に右へ移動（0.107 → 0.196）
   - pitchが前のめり（2.1° → 7.3°）
   - rollも右に傾く（8.0° → 14.5°）
   - 後脚（BR）が浮上し始める（ステップ1420以降）

3. **リセットの頻発**:
   - ステップ1900で位置移動によるリセット
   - ステップ2050以降、姿勢傾きによるリセットが頻発（pitch=27°～29°）

4. **接地状態の不安定さ**:
   - FLが1点接地（10.0N）と弱い
   - BRが浮上し始める（ステップ1420以降）
   - 4点すべてが安定して接地していない

### 技術的な注意点
- **逆運動学が失敗した理由**: Vision60のURDFモデルがPyBulletの`calculateInverseKinematics()`に適していない可能性が高い
- **角度指定方式の利点**: 各ジョイントの角度を直接制御できるため、モデルに依存しない
- **今後の方針**: 角度指定方式を改善して、より安定した立ち上がりを実現する
- **座標系の問題**: 膝下リンクのpitch判定は座標系の向きにより誤判定される可能性があるため、膝角度（90度以上）を基準に判定している
- **左右対称制御**: 左右でモーターの回転方向が逆の可能性があるが、現在は左右対称に制御している
- **足踏み動作**: 位置が動かないようにバランス制御を実装しているが、パラメータの調整が必要な場合がある
- **安定化検知**: 安定化のタイミングは物理パラメータや制御パラメータにより変動する可能性がある

### トラブルシューティング（追加）

#### 足踏み動作が開始されない場合
- 安定化検知が正常に動作しているか確認
- `stabilization_detected`が`True`になっているか確認
- ログで「🦶 足踏み動作を開始します」が出力されているか確認

#### 足踏み中に位置が動く場合
- バランス制御のゲイン（`balance_factor`）を調整
- 姿勢フィードバックゲインを増加
- 足を上げる動作の強度を調整（hip/knee角度の調整量）

#### 左右が同時に逆関節にならない場合
- 左右のバランス調整ゲインを確認
- 左右の膝角度の差を監視（ログで確認）
- 左右対称制御のロジックを確認
