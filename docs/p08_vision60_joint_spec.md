# Vision60 ジョイント仕様書

このドキュメントは、PyBulletのVision60ロボットのジョイント仕様をまとめたものです。
実際のシミュレーション結果（`p08_vision60.py`の実行ログ）に基づいています。

---

## 目次

1. [ジョイント構造](#ジョイント構造)
2. [ジョイントタイプ別仕様](#ジョイントタイプ別仕様)
3. [モーターの回転方向（正負の扱い）](#モーターの回転方向正負の扱い)
4. [制御パラメータの推奨値](#制御パラメータの推奨値)
5. [左右対称性について](#左右対称性について)

---

## ジョイント構造

### 全体構造

- **総ジョイント数**: 16個
  - 可動ジョイント（REVOLUTE）: 12個
  - 固定ジョイント（FIXED）: 4個（jtoe0, jtoe1, jtoe2, jtoe3）

### 脚の構造

各脚は以下の3つの可動ジョイントと1つの固定ジョイントで構成されています：

1. **Abductionジョイント** - 脚の横方向（外転/内転）
2. **Hipジョイント** - 脚の前後方向（屈曲/伸展）
3. **Kneeジョイント** - 膝の曲げ（屈曲のみ）
4. **Jtoeジョイント** - 固定ジョイント（制御不可）

### ジョイントインデックスマッピング

| 脚名 | Abduction | Hip | Knee | Jtoe |
|------|-----------|-----|------|------|
| **FRONT_LEFT** | 0 | 1 | 2 | 3 |
| **FRONT_RIGHT** | 4 | 5 | 6 | 7 |
| **BACK_LEFT** | 8 | 9 | 10 | 11 |
| **BACK_RIGHT** | 12 | 13 | 14 | 15 |

**コード内での定義**:
```python
LEG_JOINTS = {
    'front_left': [0, 1, 2],      # abduction, hip, knee
    'front_right': [4, 5, 6],
    'back_left': [8, 9, 10],
    'back_right': [12, 13, 14]
}
```

---

## ジョイントタイプ別仕様

### 1. Abductionジョイント（脚の横方向）

**ジョイントインデックス**: 0, 4, 8, 12

| 項目 | 値 |
|------|-----|
| **可動範囲** | **-24.6° ～ +24.6°** (-0.430 ～ +0.430 rad) |
| **最大トルク** | **375.0 N・m** |
| **最大速度** | **492.7°/s** (8.6 rad/s) |
| **用途** | 脚を左右に開く/閉じる動作 |

**特徴**:
- 4本の脚すべてで同じ仕様
- 最大トルクが最も大きい（375.0 N・m）
- 可動範囲が狭い（±24.6°）

### 2. Hipジョイント（脚の前後方向）

**ジョイントインデックス**: 1, 5, 9, 13

| 項目 | 値 |
|------|-----|
| **可動範囲** | **-180° ～ +180°** (-3.142 ～ +3.142 rad) |
| **最大トルク** | **87.5 N・m** |
| **最大速度** | **1718.9°/s** (30.0 rad/s) |
| **用途** | 脚を前後に動かす動作 |

**特徴**:
- 4本の脚すべてで同じ仕様
- 可動範囲が広い（±180°）
- 最大速度が最も速い（1718.9°/s）

### 3. Kneeジョイント（膝の曲げ）

**ジョイントインデックス**: 2, 6, 10, 14

| 項目 | 値 |
|------|-----|
| **可動範囲** | **0° ～ 180°** (0.0 ～ 3.142 rad) |
| **最大トルク** | **87.5 N・m** |
| **最大速度** | **1718.9°/s** (30.0 rad/s) |
| **用途** | 膝を曲げる動作（伸展は可動範囲外） |

**特徴**:
- 4本の脚すべてで同じ仕様
- **負の角度は取れない**（0°が最小値）
- 膝は曲げる方向のみ可動

---

## モーターの回転方向（正負の扱い）

### 基本的な考え方

PyBulletでは、ジョイント角度は**ラジアン**で指定します。
- **正の値**: ジョイントの正方向への回転
- **負の値**: ジョイントの負方向への回転

### 各ジョイントタイプの回転方向

#### Abductionジョイント（±24.6°）

```
正の角度（+）: 脚を外側に開く（外転）
負の角度（-）: 脚を内側に閉じる（内転）
```

**例**:
- `+20.0°` (0.349 rad): 脚を外側に開く
- `-20.0°` (-0.349 rad): 脚を内側に閉じる
- `0.0°`: 中立位置

#### Hipジョイント（±180°）

```
正の角度（+）: 脚を後ろに引く（後方）
負の角度（-）: 脚を前に出す（前方）
```

**注意**: 左右の脚で、同じ角度でも実際の動作方向が異なる場合があります（後述の「左右対称性について」を参照）。

**例**:
- `+30.0°` (0.524 rad): 脚を後ろに引く
- `-30.0°` (-0.524 rad): 脚を前に出す
- `0.0°`: 中立位置

#### Kneeジョイント（0°～180°）

```
正の角度（+）: 膝を曲げる（屈曲）
0°: 膝を完全に伸ばす（伸展）
```

**重要**: Kneeジョイントは**負の角度を取れません**。0°が最小値です。

**例**:
- `0.0°`: 膝を完全に伸ばす
- `90.0°` (1.571 rad): 膝を90度曲げる
- `180.0°` (3.142 rad): 膝を最大限に曲げる

### 実際の動作確認結果

ログから確認された実際の動作：

#### 前脚（FRONT_LEFT / FRONT_RIGHT）

- **Abduction**: 左右でほぼ対称的な動作
- **Hip**: 左右でほぼ対称的な動作
- **Knee**: 左右でほぼ対称的な動作

#### 後脚（BACK_LEFT / BACK_RIGHT）

- **Abduction**: 左右でほぼ対称的な動作
- **Hip**: **左右でZ方向の符号が反転**（同じ角度でも異なる方向に動く）
- **Knee**: 左右でほぼ対称的な動作

**後脚のHIPジョイントの注意点**:
```
⚠️ 後脚のHIPジョイント（ジョイント9, 13）では、
   同じ角度を指定しても、左右でZ方向の移動が反転します。
   これは正常な動作です（左右対称の構造のため）。
```

---

## 制御パラメータの推奨値

### 現在の設定との比較

現在の`p08_vision60.py`では、全ジョイントで同じパラメータを使用しています：

```python
JOINT_CONTROL_FORCE = 80.0        # 最大トルク（N・m）
JOINT_CONTROL_POSITION_GAIN = 0.5  # Pゲイン（位置ゲイン）
JOINT_CONTROL_VELOCITY_GAIN = 1.0  # Dゲイン（速度ゲイン）
```

### ジョイントタイプ別の推奨値

#### Abductionジョイント

| パラメータ | 現在値 | 推奨値 | 理由 |
|-----------|-------|--------|------|
| **force** | 80.0 N | **200.0 ～ 375.0 N** | 最大トルク375.0 Nに対して、現在の80.0 Nは約21%と不足 |
| **positionGain** | 0.5 | **0.3 ～ 0.8** | 可動範囲が狭いため、適度なゲインで十分 |
| **velocityGain** | 1.0 | **0.8 ～ 1.5** | 振動抑制のため、やや高めの値が有効 |

#### Hipジョイント

| パラメータ | 現在値 | 推奨値 | 理由 |
|-----------|-------|--------|------|
| **force** | 80.0 N | **70.0 ～ 87.5 N** | 最大トルク87.5 Nに対して、現在の80.0 Nは適切（約91%） |
| **positionGain** | 0.5 | **0.3 ～ 0.7** | 可動範囲が広いため、適度なゲインで安定 |
| **velocityGain** | 1.0 | **0.8 ～ 1.2** | 最大速度が速いため、適度な減衰が必要 |

#### Kneeジョイント

| パラメータ | 現在値 | 推奨値 | 理由 |
|-----------|-------|--------|------|
| **force** | 80.0 N | **70.0 ～ 87.5 N** | 最大トルク87.5 Nに対して、現在の80.0 Nは適切（約91%） |
| **positionGain** | 0.5 | **0.4 ～ 0.8** | 負の角度が取れないため、やや高めのゲインで安定 |
| **velocityGain** | 1.0 | **0.8 ～ 1.2** | 最大速度が速いため、適度な減衰が必要 |

### 実装例：ジョイントタイプ別のパラメータ設定

```python
# ジョイントタイプ別のパラメータ定義
JOINT_CONTROL_PARAMS = {
    'abduction': {
        'force': 200.0,
        'positionGain': 0.5,
        'velocityGain': 1.0
    },
    'hip': {
        'force': 80.0,
        'positionGain': 0.5,
        'velocityGain': 1.0
    },
    'knee': {
        'force': 80.0,
        'positionGain': 0.6,
        'velocityGain': 1.0
    }
}

# 使用例
def get_joint_params(joint_index: int) -> dict:
    """ジョイントインデックスからパラメータを取得"""
    if joint_index in [0, 4, 8, 12]:  # Abduction
        return JOINT_CONTROL_PARAMS['abduction']
    elif joint_index in [1, 5, 9, 13]:  # Hip
        return JOINT_CONTROL_PARAMS['hip']
    elif joint_index in [2, 6, 10, 14]:  # Knee
        return JOINT_CONTROL_PARAMS['knee']
    else:
        return {'force': 80.0, 'positionGain': 0.5, 'velocityGain': 1.0}
```

---

## 左右対称性について

### 前脚の対称性

前脚（FRONT_LEFT / FRONT_RIGHT）は、すべてのジョイントタイプで**ほぼ完全に対称**な動作をします。

**確認結果**:
- Abduction: 左右で同じ角度で動かすと、ほぼ同じ方向に移動
- Hip: 左右で同じ角度で動かすと、ほぼ同じ方向に移動
- Knee: 左右で同じ角度で動かすと、ほぼ同じ方向に移動

### 後脚の対称性

後脚（BACK_LEFT / BACK_RIGHT）は、**HIPジョイントでZ方向の符号が反転**します。

**確認結果**:
- Abduction: 左右でほぼ対称的な動作
- **Hip**: **左右でZ方向の符号が反転**（同じ角度でも異なる方向に動く）
- Knee: 左右でほぼ対称的な動作

**後脚HIPジョイントの動作例**:
```
目標角度: 30.0°
- 左後脚（ジョイント9）: Z方向に-0.001移動
- 右後脚（ジョイント13）: Z方向に+0.002移動

⚠️ 同じ角度でも、左右でZ方向の移動が反転しています。
```

これは、左右対称の構造のため、**正常な動作**です。制御時は、左右で異なる符号を考慮する必要があります。

### 実装時の注意点

後脚のHIPジョイントを制御する際は、左右で符号を反転させる必要がある場合があります：

```python
# 後脚HIPジョイントの制御例
if leg_name == 'back_left':
    hip_angle = target_angle  # そのまま使用
elif leg_name == 'back_right':
    hip_angle = -target_angle  # 符号を反転
```

ただし、実際の動作確認では、同じ角度でも左右で異なる方向に動くため、**目標角度自体を反転させるのではなく、制御ロジックで左右の違いを考慮**する必要があります。

---

## まとめ

### 重要なポイント

1. **Abductionジョイントは最大トルクが大きい**（375.0 N・m）
   - 現在の設定（80.0 N）では不足している可能性がある
   - 推奨値: 200.0 ～ 375.0 N

2. **Kneeジョイントは負の角度を取れない**
   - 0°が最小値（膝を完全に伸ばす）
   - 制御時は負の値を指定しないように注意

3. **後脚のHIPジョイントは左右で符号が反転**
   - 同じ角度でも、左右で異なる方向に動く
   - 制御ロジックで左右の違いを考慮する必要がある

4. **ジョイントタイプ別にパラメータを設定することを推奨**
   - 現在は全ジョイントで同じ値を使用
   - Abductionジョイントは特に大きな力が必要

### 参考情報

- **実行ログ**: `p08_vision60.py`の実行結果に基づく
- **コード定義**: `agents/p08_vision60/my_agent/utils/config.py`の`LEG_JOINTS`
- **制御実装**: `agents/p08_vision60/my_agent/utils/joint_control.py`

---

**最終更新**: 2024年（p08_vision60.pyの実行ログに基づく）
